#!/command/with-contenv bashio
# shellcheck disable=SC2086,SC2016,SC2027

    # addgroup -S rspamd
    # adduser -S -D -H -G rspamd rspamd
    mkdir -p /data/lib/rspamd
    mkdir -p /data/lib/redis
    mkdir -p /data/lib/clamav
    rm -fr /var/lib/rspamd
    rm -fr /var/lib/redis
    rm -fr /var/lib/clamav
    ln -s /data/lib/rspamd /var/lib/rspamd
    ln -s /data/lib/redis /var/lib/redis
    chown -R rspamd:rspamd /var/lib/rspamd/
    chown -R redis:redis /var/lib/redis/
    mkdir /run/clamav
    chown -R clamav:clamav /run/clamav
    ln -s /data/lib/clamav /var/lib/clamav
    chown -R clamav:clamav /var/lib/clamav/
    mkdir /run/rspamd
    
# Add symbolic link to make logging work in older supervisor
if ! readlink /dev/log >/dev/null 2>&1
then
ln -s /run/systemd/journal/dev-log /dev/log
fi

#Create rspamd encrypted password and set listening IP
rspamdpw="$(date | md5sum)"
encryptedpw="$(rspamadm pw --encrypt -p ${rspamdpw})"
encryptedenpw="$(rspamadm pw --encrypt -p ${rspamdpw})"
myip="$(ip route get 1 | awk '{print $NF;exit}')"
loglevel=$(bashio::config 'log_level')
sed -i "4 s/password = /password = "${encryptedpw}";/g" /etc/rspamd/local.d/worker-controller.inc
sed -i "5 s/enable_password = /enable_password = "${encryptedenpw}";/g" /etc/rspamd/local.d/worker-controller.inc
sed -i '2 s/^bind.*$/bind_socket = "'${myip}:11332'";/g' /etc/rspamd/local.d/worker-proxy.inc
sed -i '17 s/level = /level = "'${loglevel}'";/g' /etc/rspamd/local.d/logging.inc

if bashio::config.true "enable_antivirus"; then
    sed -i '1d' /etc/rspamd/local.d/antivirus.conf
    bashio::log.info "Updating antivirus patterns"
    freshclam
fi

if bashio::config.false "enable_dkim_signing"; then
    mv /etc/rspamd/local.d/dkim_signing.disabled /etc/rspamd/local.d/dkim_signing.conf
fi

if bashio::config.false "enable_dkim_signing" && bashio::fs.directory_exists "/ssl/dkim"; then
    bashio::log.info "DKIM signing is disabled, but old key files found. The will be removed"
    rm -rf /ssl/dkim
fi

if bashio::config.true "enable_dkim_signing"; then
    mv /etc/rspamd/local.d/dkim_signing.enabled /etc/rspamd/local.d/dkim_signing.conf
    bashio::log.info "DKIM signing is enabled"
fi

if bashio::config.true "enable_dkim_signing" && ! bashio::fs.directory_exists "/ssl/dkim"; then
    bashio::log.info "DKIM signing is enabled, but there are no keys available. Generating keys..."
    mkdir /ssl/dkim
    rspamadm dkim_keygen -b 2048 -s mail -k /ssl/dkim/mail.key | tee -a /ssl/dkim/mail.pub
    chown -R rspamd:rspamd /ssl/dkim
    bashio::log.info "DKIM keys (mail.key and mail.pub) saved to /ssl/dkim"
    bashio::log.info "Refer to the documentation on how to setup your DNS records"
fi

if bashio::config.false "enable_gtube_tests"; then
    rm /etc/rspamd/local.d/options.inc
fi

# Fix for corrupted Hyperscan files
if ! bashio::fs.file_exists '/var/lib/rspamd/Version-3.7.4'; then
    bashio::log.info "Deleting Hyperscan files to force re-creation"
    rm -rf /var/lib/rspamd/*hs*
    touch /var/lib/rspamd/Version-3.7.4
fi